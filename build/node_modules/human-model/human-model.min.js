!function(t,e){"use strict";"function"==typeof define&&define.amd?define(["underscore","backbone"],function(i,r){return t.HumanModel=e(i,r)}):"object"==typeof exports?module.exports=e(require("underscore"),require("backbone")):t.HumanModel=e(t._,t.Backbone)}(this,function(t,e){"use strict";var i=Array.prototype.slice;e.Collection.prototype._prepareModel=function(e,i){if(t.isFunction(e.initialize))return e.collection||(e.collection=this),e;i||(i={}),i.collection=this;var r=new this.model(e,i);return r._validate(e,i)?r:(this.trigger("invalid",this,e,i),!1)};var r=function(t,e){var i=t.length,r=t.indexOf(e)+1;return r>i-1&&(r=0),t[r]},n=function(e,i,r){var n=e._derived[i]={fn:t.isFunction(r)?r:r.fn,cache:r.cache!==!1,depList:r.deps||[]};t.each(n.depList,function(r){e._deps[r]=t(e._deps[r]||[]).union([i])}),Object.defineProperty(e,i,{get:function(){return this._getDerivedProperty(i)},set:function(){throw new TypeError('"'+i+"\" is a derived property, it can't be set directly.")}})},s=function(){this._cache={},this._namespaces={}};t.extend(s.prototype,{_getCache:function(t){return t?(this._namespaces[t]||(this._namespaces[t]={}),this._namespaces[t]):this._cache},lookup:function(t,e,i){var r=this._getCache(i);return r&&r[t+e]},store:function(t){var e=this._getCache(t._namespace),i=t.type+t.getId();return e[i]=e[i]||t,this},remove:function(t,e,i){var r=this._getCache(i);return this.lookup.apply(this,arguments)?(delete r[t+e],!0):!1},clear:function(){this._cache={},this._namespaces={}}});var o=new s,a={date:{set:function(e){var i;if(t.isDate(e))i="date",e=e.valueOf();else try{e=new Date(parseInt(e,10)).valueOf(),i="date"}catch(r){i=typeof e}return{val:e,type:i}},get:function(t){return new Date(t)}},array:{set:function(e){return{val:e,type:t.isArray(e)?"array":typeof e}}},object:{set:function(e){var i=typeof e;return"object"!==i&&t.isUndefined(e)&&(e=null,i="object"),{val:e,type:i}}}},u=function(s){s||(s={});var u,l=function(e,i){e||(e={}),i||(i={}),this.cid=t.uniqueId("model"),this.collection=i.collection||void 0,i.parse&&(e=this.parse(e,i)||{}),this.registry=i.registry||o,i._attrs=e,this._namespace=i.namespace,this._initted=!1,this._values={},this._initCollections(),this._cache={},this._previousAttributes={},this._events={},this.set(e,t.extend({silent:!0,initial:!0},i)),this._changed={},this.initialize.apply(this,arguments),e[this.idAttribute]&&this.registry.store(this),this._initted=!0,this.seal&&Object.seal(this)};Object.defineProperties(l.prototype,{attributes:{get:function(){return this._getAttributes(!0)}},json:{get:function(){return JSON.stringify(this.serialize())}},derived:{get:function(){var t={};for(var e in this._derived)t[e]=this._derived[e].fn.apply(this);return t}},toTemplate:{get:function(){return t.extend(this._getAttributes(!0),this.derived)}}}),t.extend(l.prototype,e.Events,{idAttribute:"id",_derived:{},_deps:{},_definition:{},extraProperties:"ignore",getId:function(){return this.get(this.idAttribute)},initialize:function(){return this},parse:function(t){return t},serialize:function(){return this._getAttributes(!1,!0)},remove:function(){return this.getId()&&this.registry.remove(this.type,this.getId(),this._namespace),this.trigger("remove",this),this.off(),this},set:function(e,i,r){function n(e){A.push(e),t.each(_._deps[e]||[],function(t){n(t)})}var s,o,u,c,h,l,f,d,p,y,v,g,_=this,b=this.extraProperties;if(t.isObject(e)||null===e?(d=e,r=i):(d={},d[e]=i),r=r||{},!this._validate(d,r))return!1;y=r.unset,p=r.silent,g=r.initial,u=[],s=this._changing,this._changing=!0,s||(this._previousAttributes=this._getAttributes(!0),this._changed={}),o=this._previousAttributes;for(f in d){if(h=d[f],c=typeof h,v=this._values[f],l=this._definition[f],!l){if("ignore"===b)continue;if("reject"===b)throw new TypeError('No "'+f+'" property defined on '+(this.type||"this")+" model and allowOtherProperties not set.");"allow"===b&&(l=this._createPropertyDefinition(f,"any"))}if(a[l.type]){var w=a[l.type].set(h);h=w.val,c=w.type}if(l.test){var m=l.test(h,c);if(m)throw new TypeError("Property '"+f+"' failed validation with error: "+m)}if(t.isUndefined(h)&&l.required)throw new TypeError("Required property '"+f+"' must be of type "+l.type+". Tried to set "+h);if(t.isNull(h)&&l.required&&!l.allowNull)throw new TypeError("Property '"+f+"' must be of type "+l.type+" (cannot be null). Tried to set "+h);if(l.type&&"any"!==l.type&&l.type!==c&&!t.isNull(h)&&!t.isUndefined(h))throw new TypeError("Property '"+f+"' must be of type "+l.type+". Tried to set "+h);if(l.values&&!t.contains(l.values,h))throw new TypeError("Property '"+f+"' must be one of values: "+l.values.map(function(t){return t.toString()}).join(", "));if(l.setOnce&&void 0!==v&&!t.isEqual(v,h))throw new TypeError("Property '"+e+"' can only be set once.");t.isEqual(v,h)||u.push({prev:v,val:h,key:f}),t.isEqual(o[f],h)?delete _._changed[f]:_._changed[f]=h}t.each(u,function(t){_._previousAttributes[t.key]=t.prev,y?delete _._values[t.key]:_._values[t.key]=t.val});var A=[];if(!p&&u.length&&(_._pending=!0),t.each(u,function(t){n(t.key)}),t.each(t.uniq(A),function(e){var i=_._derived[e];if(i&&i.cache&&!g){var r=_._cache[e],n=_._getDerivedProperty(e,!0);t.isEqual(r,n)||(_._previousAttributes[e]=r,p||_.trigger("change:"+e,_,n))}else p||_.trigger("change:"+e,_,_[e])}),s)return this;if(!p)for(;this._pending;)this._pending=!1,this.trigger("change",this,r);return this._pending=!1,this._changing=!1,this},get:function(t){return this[t]},toggle:function(t){var e=this._definition[t];if("boolean"===e.type)this[t]=!this[t];else{if(!e||!e.values)throw new TypeError("Can only toggle properties that are type `boolean` or have `values` array.");this[t]=r(e.values,this[t])}return this},previousAttributes:function(){return t.clone(this._previousAttributes)},save:function(e,i,r){var n,s,o;if(this.attributes,null==e||"object"==typeof e?(n=e,r=i):(n={})[e]=i,r=t.extend({validate:!0},r),n&&!r.wait){if(!this.set(n,r))return!1}else if(!this._validate(n,r))return!1;void 0===r.parse&&(r.parse=!0);var a=this,u=r.success;return r.success=function(e){var i=a.parse(e,r);return r.wait&&(i=t.extend(n||{},i)),t.isObject(i)&&!a.set(i,r)?!1:(u&&u(a,e,r),a.trigger("sync",a,e,r),void 0)},c(this,r),s=this.isNew()?"create":r.patch?"patch":"update","patch"===s&&(r.attrs=n),r.wait&&(r.attrs=t.extend(a.serialize(),n)),o=this.sync(s,this,r)},fetch:function(e){e=e?t.clone(e):{},void 0===e.parse&&(e.parse=!0);var i=this,r=e.success;return e.success=function(t){return i.set(i.parse(t,e),e)?(r&&r(i,t,e),i.trigger("sync",i,t,e),void 0):!1},c(this,e),this.sync("read",this,e)},destroy:function(e){e=e?t.clone(e):{};var i=this,r=e.success,n=function(){i.trigger("destroy",i,i.collection,e)};if(e.success=function(t){(e.wait||i.isNew())&&n(),r&&r(i,t,e),i.isNew()||i.trigger("sync",i,t,e)},this.isNew())return e.success(),!1;c(this,e);var s=this.sync("delete",this,e);return e.wait||n(),s},hasChanged:function(e){return null==e?!t.isEmpty(this._changed):t.has(this._changed,e)},changedAttributes:function(e){if(!e)return this.hasChanged()?t.clone(this._changed):!1;var i,r=!1,n=this._changing?this._previousAttributes:this._getAttributes(!0);for(var s in e)t.isEqual(n[s],i=e[s])||((r||(r={}))[s]=i);return r},toJSON:function(){return this.serialize()},has:function(t){return null!=this.get(t)},url:function(){var e=t.result(this,"urlRoot")||t.result(this.collection,"url")||h();return this.isNew()?e:e+("/"===e.charAt(e.length-1)?"":"/")+encodeURIComponent(this.getId())},isNew:function(){return null==this.getId()},clone:function(){return new this.constructor(this._getAttributes(!0))},isValid:function(e){return this._validate({},t.extend(e||{},{validate:!0}))},escape:function(e){return t.escape(this[e])},sync:function(){return e.sync.apply(this,arguments)},unset:function(e,i){var r,n=this._definition[e],s=n.type;return n.required?(r=t.isUndefined(n.default)?this._getDefaultForType(s):n.default,this.set(e,r,i)):this.set(e,r,t.extend({},i,{unset:!0}))},clear:function(e){var i=this;return t.each(this._getAttributes(!0),function(t,r){i.unset(r,e)}),this},_validate:function(e,i){if(!i.validate||!this.validate)return!0;e=t.extend({},this.attributes,e);var r=this.validationError=this.validate(e,i)||null;return r?(this.trigger("invalid",this,r,t.extend(i||{},{validationError:r})),!1):!0},_getDefaultForType:function(t){return"string"===t?"":"object"===t?{}:"array"===t?[]:void 0},addListVal:function(e,i,r){var n=t.clone(this[e])||[];return t(n).contains(i)||(n[r?"unshift":"push"](i),this[e]=n),this},previous:function(t){return null!=t&&Object.keys(this._previousAttributes).length?this._previousAttributes[t]:null},removeListVal:function(e,i){var r=t.clone(this[e])||[];return t(r).contains(i)&&(this[e]=t(r).without(i)),this},hasListVal:function(e,i){return t.contains(this[e]||[],i)},_initCollections:function(){var t;if(this._collections)for(t in this._collections)this[t]=new this._collections[t],this[t].parent=this},_verifyRequired:function(){var t=this._getAttributes(!0);for(var e in this._definition)if(this._definition[e].required&&"undefined"==typeof t[e])return!1;return!0},_createPropertyDefinition:function(e,i,r){var n,s=this,o=this._definition[e]={};return t.isString(i)?(n=this._ensureValidType(i),n&&(o.type=n)):(n=this._ensureValidType(i[0]||i.type),n&&(o.type=n),(i[1]||i.required)&&(o.required=!0),o.default=t.isUndefined(i[2])?i.default:i[2],o.allowNull=i.allowNull?i.allowNull:!1,i.setOnce&&(o.setOnce=!0),o.required&&t.isUndefined(o.default)&&(o.default=this._getDefaultForType(n)),o.test=i.test,o.values=i.values),r&&(o.session=!0),Object.defineProperty(s,e,{set:function(t){this.set(e,t)},get:function(){var t=this._values[e];return"undefined"!=typeof t?(a[o.type]&&a[o.type].get&&(t=a[o.type].get(t)),t):o.default}}),o},_ensureValidType:function(e){return t.contains(["string","number","boolean","array","object","date","any"].concat(t.keys(a)),e)?e:void 0},_getAttributes:function(t,e){var i,r,n,s={};for(r in this._definition)n=this._definition[r],(!n.session||t&&n.session)&&(i=e?this._values[r]:this[r],"undefined"==typeof i&&(i=n.default),"undefined"!=typeof i&&(s[r]=i));return s},_getDerivedProperty:function(t,e){return this._derived[t].cache?!e&&this._cache.hasOwnProperty(t)?this._cache[t]:this._cache[t]=this._derived[t].fn.apply(this):this._derived[t].fn.apply(this)}});var f=["keys","values","pairs","invert","pick","omit"];t.each(f,function(e){l.prototype[e]=function(){var r=i.call(arguments);return r.unshift(this.attributes),t[e].apply(t,r)}});for(u in s)"props"===u||"session"===u?t.each(s[u],function(t,e){l.prototype._createPropertyDefinition.call(l.prototype,e,t,"session"===u)}):"derived"===u?t.each(s[u],function(t,e){n(l.prototype,e,t)}):"collections"===u?l.prototype._collections=s[u]:l.prototype[u]=s[u];return l.registry=o,l},c=function(t,e){var i=e.error;e.error=function(r){i&&i(t,r,e),t.trigger("error",t,r,e)}},h=function(){throw new Error('A "url" property or function must be specified')};return{define:u,registry:o,Registry:s,dataTypes:a}});